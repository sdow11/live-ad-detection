{% extends "base.html" %}

{% block title %}PiP Content Management{% endblock %}

{% block content %}
<h1 style="margin-bottom: 20px;">PiP Content Management</h1>

<!-- Add Content Button -->
<div style="margin-bottom: 20px;">
    <button class="btn btn-success" onclick="showModal('addContentModal')">+ Add Content Source</button>
</div>

<!-- Content Sources -->
<div class="card">
    <h2>Content Sources</h2>
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Source</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for content in content_sources %}
            <tr>
                <td><strong>{{ content.name }}</strong></td>
                <td>
                    <span class="status-badge">{{ content.content_type }}</span>
                </td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                    {{ content.source_uri }}
                </td>
                <td>{{ content.created_at[:10] }}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteContent('{{ content.content_id }}')">Delete</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align: center; padding: 30px; color: #999;">
                    No content sources configured. Click "Add Content Source" to get started.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Device PiP Configuration -->
<div class="card">
    <h2>Device PiP Configuration</h2>
    <p style="margin-bottom: 15px; color: #666;">Configure what content each device displays during ad breaks.</p>

    {% for device_config in device_configs %}
    <div class="card" style="margin-bottom: 15px; background: #f8f9fa;">
        <h3>{{ device_config.device.hostname or device_config.device.device_id }}</h3>

        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
            <div style="flex: 1;">
                <label><strong>Default Content:</strong></label>
                <select id="default_content_{{ device_config.device.device_id }}" style="width: 100%; padding: 8px; margin-top: 5px;">
                    <option value="">None (Disabled)</option>
                    {% for content in content_sources %}
                    <option value="{{ content.content_id }}"
                        {% if device_config.config and device_config.config.default_content_id == content.content_id %}selected{% endif %}>
                        {{ content.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div style="flex: 1;">
                <label><strong>PiP Enabled:</strong></label>
                <select id="enabled_{{ device_config.device.device_id }}" style="width: 100%; padding: 8px; margin-top: 5px;">
                    <option value="true" {% if not device_config.config or device_config.config.enabled %}selected{% endif %}>Yes</option>
                    <option value="false" {% if device_config.config and not device_config.config.enabled %}selected{% endif %}>No</option>
                </select>
            </div>

            <div style="display: flex; align-items: flex-end;">
                <button class="btn btn-success" onclick="saveDeviceConfig('{{ device_config.device.device_id }}')">
                    Save Config
                </button>
            </div>
        </div>

        <!-- Schedules -->
        {% if device_config.config and device_config.config.schedules %}
        <div style="margin-top: 15px;">
            <strong>Schedules:</strong>
            <table style="margin-top: 10px;">
                <thead>
                    <tr>
                        <th>Content</th>
                        <th>Days</th>
                        <th>Time Range</th>
                        <th>Priority</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for schedule in device_config.config.schedules %}
                    <tr>
                        <td>
                            {% for content in content_sources %}
                                {% if content.content_id == schedule.content_id %}
                                    {{ content.name }}
                                {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            {% if schedule.days_of_week %}
                                {% for day in schedule.days_of_week %}
                                    {{ ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'][day] }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            {% else %}
                                All days
                            {% endif %}
                        </td>
                        <td>
                            {% if schedule.start_time and schedule.end_time %}
                                {{ schedule.start_time }} - {{ schedule.end_time }}
                            {% else %}
                                All day
                            {% endif %}
                        </td>
                        <td>{{ schedule.priority }}</td>
                        <td>
                            <button class="btn btn-sm btn-danger"
                                onclick="deleteSchedule('{{ device_config.device.device_id }}', '{{ schedule.schedule_id }}')">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <div style="margin-top: 10px;">
            <button class="btn btn-sm" onclick="showAddScheduleModal('{{ device_config.device.device_id }}')">
                + Add Schedule
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Content Modal -->
<div id="addContentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Content Source</h2>
        </div>

        <form id="addContentForm" onsubmit="addContent(event)">
            <div class="form-group">
                <label>Content ID *</label>
                <input type="text" name="content_id" required placeholder="e.g., promo-video-1">
            </div>

            <div class="form-group">
                <label>Name *</label>
                <input type="text" name="name" required placeholder="e.g., Promotional Video">
            </div>

            <div class="form-group">
                <label>Content Type *</label>
                <select name="content_type" required onchange="updateSourceUriPlaceholder(this)">
                    {% for ct in content_types %}
                    <option value="{{ ct }}">{{ ct.replace('_', ' ').title() }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Source URI *</label>
                <input type="text" name="source_uri" id="source_uri" required placeholder="/path/to/video.mp4 or http://stream-url">
            </div>

            <div class="form-group">
                <label>Upload File (optional, for video/image)</label>
                <input type="file" name="file" accept="video/*,image/*">
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea name="description" rows="3" placeholder="Optional description"></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn" onclick="hideModal('addContentModal')">Cancel</button>
                <button type="submit" class="btn btn-success">Add Content</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Schedule Modal -->
<div id="addScheduleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add Content Schedule</h2>
        </div>

        <form id="addScheduleForm" onsubmit="addSchedule(event)">
            <input type="hidden" name="device_id" id="schedule_device_id">

            <div class="form-group">
                <label>Schedule ID *</label>
                <input type="text" name="schedule_id" required placeholder="e.g., lunch-hours">
            </div>

            <div class="form-group">
                <label>Content *</label>
                <select name="content_id" required>
                    {% for content in content_sources %}
                    <option value="{{ content.content_id }}">{{ content.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Days of Week (comma-separated: 0=Mon, 6=Sun, leave empty for all days)</label>
                <input type="text" name="days_of_week" placeholder="e.g., 0,1,2,3,4 for weekdays">
            </div>

            <div class="form-group">
                <label>Start Time (HH:MM, leave empty for all day)</label>
                <input type="time" name="start_time">
            </div>

            <div class="form-group">
                <label>End Time (HH:MM, leave empty for all day)</label>
                <input type="time" name="end_time">
            </div>

            <div class="form-group">
                <label>Priority (higher = higher priority)</label>
                <input type="number" name="priority" value="0">
            </div>

            <div class="modal-footer">
                <button type="button" class="btn" onclick="hideModal('addScheduleModal')">Cancel</button>
                <button type="submit" class="btn btn-success">Add Schedule</button>
            </div>
        </form>
    </div>
</div>

<script>
    function updateSourceUriPlaceholder(select) {
        const uriInput = document.getElementById('source_uri');
        const placeholders = {
            'video_file': '/var/lib/ad-detection/videos/promo.mp4',
            'image': '/var/lib/ad-detection/images/logo.png',
            'slideshow': '/var/lib/ad-detection/images/',
            'stream_url': 'rtsp://stream-server/feed or http://stream.example.com/live.m3u8',
            'hdmi_input': 'HDMI2',
            'web_page': 'http://dashboard.example.com',
            'black_screen': 'black',
            'custom_overlay': '/var/lib/ad-detection/overlays/custom.png'
        };
        uriInput.placeholder = placeholders[select.value] || '';
    }

    async function addContent(event) {
        event.preventDefault();
        const formData = new FormData(event.target);

        try {
            const response = await fetch('/api/content/add', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                showAlert('Content source added successfully', 'success');
                hideModal('addContentModal');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('Failed to add content: ' + data.detail, 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    async function deleteContent(contentId) {
        if (!confirm('Are you sure you want to delete this content source?')) {
            return;
        }

        try {
            const response = await fetch(`/api/content/${contentId}/delete`, {
                method: 'POST'
            });

            if (response.ok) {
                showAlert('Content source deleted successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('Failed to delete content', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    async function saveDeviceConfig(deviceId) {
        const defaultContent = document.getElementById(`default_content_${deviceId}`).value;
        const enabled = document.getElementById(`enabled_${deviceId}`).value === 'true';

        const formData = new FormData();
        if (defaultContent) {
            formData.append('default_content_id', defaultContent);
        }
        formData.append('enabled', enabled);

        try {
            const response = await fetch(`/api/device/${deviceId}/pip-config`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                showAlert('Device configuration saved successfully', 'success');
            } else {
                showAlert('Failed to save configuration: ' + data.detail, 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    function showAddScheduleModal(deviceId) {
        document.getElementById('schedule_device_id').value = deviceId;
        showModal('addScheduleModal');
    }

    async function addSchedule(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        const deviceId = formData.get('device_id');

        try {
            const response = await fetch(`/api/device/${deviceId}/schedule/add`, {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (response.ok) {
                showAlert('Schedule added successfully', 'success');
                hideModal('addScheduleModal');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('Failed to add schedule: ' + data.detail, 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }

    async function deleteSchedule(deviceId, scheduleId) {
        if (!confirm('Are you sure you want to delete this schedule?')) {
            return;
        }

        try {
            const response = await fetch(`/api/device/${deviceId}/schedule/${scheduleId}/delete`, {
                method: 'POST'
            });

            if (response.ok) {
                showAlert('Schedule deleted successfully', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert('Failed to delete schedule', 'error');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'error');
        }
    }
</script>
{% endblock %}
